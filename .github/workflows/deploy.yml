name: Deploy to Aliyun OSS (Hong Kong)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 检出代码
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ 安装 ossutil
      - name: Install ossutil
        run: |
          curl -o ossutil64 https://gosspublic.alicdn.com/ossutil/1.7.17/ossutil64
          chmod +x ossutil64

      # 3️⃣ 配置阿里云凭证
      - name: Configure OSS credentials
        run: |
          echo "[Credentials]" > ~/.ossutilconfig
          echo "language=EN" >> ~/.ossutilconfig
          echo "endpoint=oss-cn-hongkong.aliyuncs.com" >> ~/.ossutilconfig
          echo "accessKeyID=${{ secrets.OSS_KEY_ID }}" >> ~/.ossutilconfig
          echo "accessKeySecret=${{ secrets.OSS_KEY_SECRET }}" >> ~/.ossutilconfig

      # 4️⃣ 构建干净的部署目录
      - name: Prepare deploy folder
        run: |
          mkdir deploy
          rsync -av --progress ./ ./deploy \
            --exclude ".git" \
            --exclude ".github" \
            --exclude ".gitignore" \
            --exclude "ossutil64"

      # 5️⃣ 清空 bucket（⚠️谨慎：会删除 OSS 中所有内容）
      - name: Clean OSS bucket
        run: |
          ./ossutil64 rm oss://zziyan-hk/ -r -f

      # 6️⃣ 上传干净的网站文件
      - name: Upload website files to OSS
        run: |
          ./ossutil64 cp -r ./deploy oss://zziyan-hk/ --update
